window.onload=()=>{const r={exit:{main:"Do you really want to go to the menu?",sub:"Your current points are not saved"},restart:{main:"Do you really want to start over?",sub:"Your current points are not saved"},gameover:{main:"GAME OVER",sub:"Want to start over?"},bestgameover:{main:"GAME OVER. BEST SCORE!",sub:"Want to start over?"}},o=()=>{const e=document.createElement("a");e.href="main.html",e.click()},c=()=>{const e=document.createElement("a");e.href="tetris.html",e.click()},i=configuration.TETRISHEIGHT,t=document.getElementById("game");let l=configuration.GRIDSIZE;const a=t.getContext("2d"),s=document.getElementById("next"),m=s.getContext("2d");function n(e){M=!0,cancelAnimationFrame(N);const t=document.querySelector(".gameover"),n=document.querySelector(".gameover__actions");t.children[0].textContent=r[e].main,t.children[1].textContent=r[e].sub,"exit"===e&&(n.children[0].onclick=o,n.children[1].onclick=_),"restart"===e&&(n.children[0].onclick=c,n.children[1].onclick=_),"gameover"!==e&&"bestgameover"!==e||(n.children[0].onclick=c,n.children[1].onclick=o,t.classList.add("bold")),n.children[0].addEventListener("click",()=>{t.classList.remove("show"),t.classList.remove("bold")}),n.children[1].addEventListener("click",()=>{t.classList.remove("show"),t.classList.remove("bold")}),t.classList.add("show")}const e=document.getElementById("actions");function d(){l=Math.floor((window.innerHeight-130)/configuration.TETRISHEIGHT),t.height=i*l,t.width=10*l,s.height=2*l,s.width=4*l;const e=document.querySelector(".gameover");e.style.width=10*l+150+"px"}e.children[0].onclick=e=>{n("restart")},e.children[1].onclick=e=>{n("exit")},d();var u=[],h=[];for(let t=-2;t<i;t++){h[t]=[];for(let e=0;e<10;e++)h[t][e]=0}const f={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]],T:[[0,1,0],[1,1,1],[0,0,0]]},g={I:"#e20e0e",O:"#e28166",T:"#4b57f2",S:"#069c93",Z:"#5a9c06",J:"#a90ee2",L:"#e2810e"},E=configuration.COUNTTOCHANGE;let v=0,S=0,w=0,y=1,b=0,I="",T="",O=0,A=!1,x=!1;setTimeout(()=>{A=!0,x=!0},configuration.EXPECTATION);let L=B(),N=null,R=!1,M=!1;function p(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function H(e,t){t&&y++;let n=["I","J","L","O","S","T","Z"];"NEUTRAL"===e?n=["S","Z"]:"NEGATIVE"===e&&(n=["I"]);e=p(0,n.length-1),e=n.slice(e,e+1)[0];u.push(e)}function k(e){switch(e||I){case"H":case"U":return"POSITIVE";case"N":case"G":return"NEUTRAL";case"A":case"D":case"S":return"NEGATIVE"}}function G(){const e=document.getElementById("emotion");I&&(e.innerHTML=`<div>Emotion:<br />${{H:"Happy",U:"Wonder",N:"OK",G:"Sad",A:"Angry",D:"Disgust",S:"Scared"}[I]}<div>`);const t=document.getElementById("score");t.innerHTML="Score:<br />"+b;const n=document.getElementById("level");n.innerHTML="Level:<br />"+y;const r=document.getElementById("lines");r.innerHTML="Lines:<br />"+w;let o=localStorage.getItem("scores");o=o?JSON.parse(o):{};var c=Object.keys(o).reduce((e,t)=>t>Number(e)?t:Number(e),0);const i=document.getElementById("bestscore");i.innerHTML="Best score:<br />"+Math.max(c,b)}function D(){var e=["H","U","N","G","A","D","S"];return e[p(0,e.length-1)]}function C(){if(m.clearRect(0,0,s.width,s.height),u&&0<u.length&&u[u.length-1]){m.fillStyle=g[u[u.length-1]];var n=f[u[u.length-1]];for(let t=0;t<4;t++)for(let e=0;e<4;e++)n[t]&&n[t][e]&&m.fillRect(e*l,t*l,l-1,l-1)}}function B(){if(0===u.length){let e=!1;v>=E&&(t=T,I=D(),T=k(),v=0,e=t===T),H(T,e),G()}var t=u.pop();if(0===u.length){x&&w&&v++;let e=!1;(v>=E||A&&w)&&(n=T,I=D(),T=k(),v=0,e=n===T,A=!1),H(T,e),G(),C()}var n=f[t];return{name:t,matrix:n,row:"I"===t?-1:-2,col:h[0].length/2-Math.ceil(n[0].length/2)}}function F(n,r,o){for(let t=0;t<n.length;t++)for(let e=0;e<n[t].length;e++)if(n[t][e]&&(o+e<0||o+e>=h[0].length||r+t>=h.length||h[r+t][o+e]))return;return 1}function J(){for(let t=0;t<L.matrix.length;t++)for(let e=0;e<L.matrix[t].length;e++)if(L.matrix[t][e]){if(L.row+t<=0)return function(){cancelAnimationFrame(N),R=!0;let e=localStorage.getItem("scores");e=e?JSON.parse(e):{};b&&(e[b.toString()]=(new Date).valueOf(),localStorage.setItem("scores",JSON.stringify(e)));!b||e&&!Object.keys(e).every(e=>Number(e)<b)?n("gameover"):n("bestgameover")}(),0;h[L.row+t][L.col+e]=L.name}let t=0;for(let e=h.length-1;0<=e;)if(h[e].every(e=>!!e)){t++;for(let t=e;0<=t;t--)for(let e=0;e<h[t].length;e++)h[t][e]=h[t-1][e]}else e--;if(S+=t,w+=t,b+100>=Number.MAX_SAFE_INTEGER){let e=localStorage.getItem("scores");e=e?JSON.parse(e):{},b&&(e[Number.MAX_SAFE_INTEGER]=(new Date).valueOf(),localStorage.setItem("scores",JSON.stringify(e))),function(){cancelAnimationFrame(N);const t=document.querySelector("body");t.style.display="flex",t.style.alignItems="center",Array.from(t.children).map(e=>{t.removeChild(e)});const e=document.createElement("div");t.appendChild(e),e.innerHTML='<b>OOPS!</b><br />ERROR! GAMER DETECTED!<br />STOP PLAYING AND DO YOUR HOMEWORK!<br />(MAX SCORE REACHED)<br /><button id="error">OK</button>',e.style.textAlign="center",e.style.fontSize="25px",e.onclick=o}()}1===t?b+=100:2===t?b+=300:3===t?b+=700:4===t&&(b+=1e3),10<=S&&(y++,S-=10),G(),L=B()}function q(){a.clearRect(0,0,t.width,t.height);for(let t=0;t<i;t++)for(let e=0;e<10;e++){var n;h[t][e]&&(n=h[t][e],a.fillStyle=g[n],a.fillRect(e*l,t*l,l-1,l-1))}if(L){++O>36-y&&(L.row++,O=0,F(L.matrix,L.row,L.col)||(L.row--,J())),a.fillStyle=g[L.name];for(let t=0;t<L.matrix.length;t++)for(let e=0;e<L.matrix[t].length;e++)L.matrix[t][e]&&a.fillRect((L.col+e)*l,(L.row+t)*l,l-1,l-1)}}function U(){N=requestAnimationFrame(U),q()}function _(){M=!1,N=requestAnimationFrame(U)}G(),document.addEventListener("keydown",function(e){var t;if(!R&&(37!==e.which&&39!==e.which||(t=37===e.which?L.col-1:L.col+1,F(L.matrix,L.row,t)&&(L.col=t)),38!==e.which||F(t=function(r){const o=r.length-1;return r.map((e,n)=>e.map((e,t)=>r[o-t][n]))}(L.matrix),L.row,L.col)&&(L.matrix=t),40===e.which)){e=L.row+1;if(!F(L.matrix,e,L.col))return L.row=e-1,void J();L.row=e}}),N=requestAnimationFrame(U),document.addEventListener("keydown",function(e){"Escape"===e.code&&n("exit"),"KeyR"===e.code&&n("restart")}),window.addEventListener("resize",()=>{d(),C(),q()})};