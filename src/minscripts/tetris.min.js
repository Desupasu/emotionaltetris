window.onload=()=>{const e=configuration.TETRISHEIGHT,l=document.getElementById("game");let i=configuration.GRIDSIZE;const o=l.getContext("2d"),t=document.getElementById("next"),r=t.getContext("2d");function n(){i=Math.floor((window.innerHeight-120)/configuration.TETRISHEIGHT),l.height=e*i,l.width=10*i,t.height=2*i,t.width=4*i}n();var c=[],a=[];for(let t=-2;t<e;t++){a[t]=[];for(let e=0;e<10;e++)a[t][e]=0}const h={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]],T:[[0,1,0],[1,1,1],[0,0,0]]},f={I:"cyan",O:"yellow",T:"purple",S:"green",Z:"red",J:"blue",L:"orange"},m=configuration.COUNTTOCHANGE;let g=0,s=0,d=0,u=1,w=0,E="",S="",x=0,T=!1,y=!1;setTimeout(()=>{T=!0,y=!0},configuration.EXPECTATION);let A=M(),I=null,p=!1,b=!1;function v(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function O(e,t){t&&u++;let n=["I","J","L","O","S","T","Z"];"NEUTRAL"===e?n=["S","Z"]:"NEGATIVE"===e&&(n=["I"]),e=v(0,n.length-1),e=n.slice(e,e+1)[0],c.push(e)}function R(e){switch(e||E){case"H":case"U":return"POSITIVE";case"N":case"G":return"NEUTRAL";case"A":case"D":case"S":return"NEGATIVE"}}function N(){const e=document.getElementById("emotion");E&&(o=["H","U","N","G","A","D","S"].indexOf(E),e.innerHTML='<div>Emotion:<br /><img src="../icons/'+(o+1)+'.png"><div>');const t=document.getElementById("score");t.innerHTML="Score:<br />"+w;const n=document.getElementById("level");n.innerHTML="Level:<br />"+u;const l=document.getElementById("lines");l.innerHTML="Lines:<br />"+d;let i=localStorage.getItem("scores");i=i?JSON.parse(i):{};var o=Object.keys(i).reduce((e,t)=>t>Number(e)?t:Number(e),0);const r=document.getElementById("bestscore");r.innerHTML="Best score:<br />"+Math.max(o,w)}function L(){var e=["H","U","N","G","A","D","S"];return e[v(0,e.length-1)]}function H(){if(r.clearRect(0,0,t.width,t.height),c&&0<c.length&&c[c.length-1]){r.fillStyle=f[c[c.length-1]];var n=h[c[c.length-1]];for(let t=0;t<4;t++)for(let e=0;e<4;e++)n[t]&&n[t][e]&&r.fillRect(e*i,t*i,i-1,i-1)}}function M(){if(0===c.length){let e=!1;g>=m&&(t=S,E=L(),S=R(),g=0,e=t===S),O(S,e),N()}var t=c.pop();if(0===c.length){y&&d&&g++;let e=!1;(g>=m||T&&d)&&(n=S,E=L(),S=R(),g=0,e=n===S,T=!1),O(S,e),N(),H()}var n=h[t];return{name:t,matrix:n,row:"I"===t?-1:-2,col:a[0].length/2-Math.ceil(n[0].length/2)}}function B(n,l,i){for(let t=0;t<n.length;t++)for(let e=0;e<n[t].length;e++)if(n[t][e]&&(i+e<0||i+e>=a[0].length||l+t>=a.length||a[l+t][i+e]))return;return 1}function G(){for(let t=0;t<A.matrix.length;t++)for(let e=0;e<A.matrix[t].length;e++)if(A.matrix[t][e]){if(A.row+t<0)return function(){if(cancelAnimationFrame(I),p=!0,w){let e=localStorage.getItem("scores");e=e?JSON.parse(e):{},e&&!Object.keys(e).every(e=>Number(e)<w)||(o.fillStyle="black",o.globalAlpha=.75,o.fillRect(0,l.height/2-60,l.width,120),o.globalAlpha=1,o.fillStyle="white",o.font="36px monospace",o.textAlign="center",o.textBaseline="middle",o.fillText("GAME OVER!",l.width/2,l.height/2+25),o.fillText("BEST SCORE!",l.width/2,l.height/2-25)),e[w.toString()]=(new Date).valueOf(),localStorage.setItem("scores",JSON.stringify(e))}else o.fillStyle="black",o.globalAlpha=.75,o.fillRect(0,l.height/2-30,l.width,60),o.globalAlpha=1,o.fillStyle="white",o.font="36px monospace",o.textAlign="center",o.textBaseline="middle",o.fillText("GAME OVER!",l.width/2,l.height/2)}(),0;a[A.row+t][A.col+e]=A.name}let t=0;for(let e=a.length-1;0<=e;)if(a[e].every(e=>!!e)){t++;for(let t=e;0<=t;t--)for(let e=0;e<a[t].length;e++)a[t][e]=a[t-1][e]}else e--;s+=t,d+=t,alert(t),1===t?w+=100:2===t?w+=300:3===t?w+=700:4===t&&(w+=1e3),10<=s&&(u++,s-=10),N(),A=M()}function k(){o.clearRect(0,0,l.width,l.height);for(let t=0;t<e;t++)for(let e=0;e<10;e++){var n;a[t][e]&&(n=a[t][e],o.fillStyle=f[n],o.fillRect(e*i,t*i,i-1,i-1))}if(A){++x>36-u&&(A.row++,x=0,B(A.matrix,A.row,A.col)||(A.row--,G())),o.fillStyle=f[A.name];for(let t=0;t<A.matrix.length;t++)for(let e=0;e<A.matrix[t].length;e++)A.matrix[t][e]&&o.fillRect((A.col+e)*i,(A.row+t)*i,i-1,i-1)}}function U(){I=requestAnimationFrame(U),k()}N(),document.addEventListener("keydown",function(e){if(!p){var t;if(37!==e.which&&39!==e.which||(t=37===e.which?A.col-1:A.col+1,B(A.matrix,A.row,t)&&(A.col=t)),38!==e.which||B(n=function(l){const i=l.length-1;return l.map((e,n)=>e.map((e,t)=>l[i-t][n]))}(A.matrix),A.row,A.col)&&(A.matrix=n),40===e.which){var n=A.row+1;if(!B(A.matrix,n,A.col))return A.row=n-1,void G();A.row=n}"KeyP"===e.code&&(b?(b=!1,I=requestAnimationFrame(U)):(b=!0,cancelAnimationFrame(I),o.fillStyle="black",o.globalAlpha=.75,o.fillRect(0,l.height/2-30,l.width,60),o.globalAlpha=1,o.fillStyle="white",o.font="36px monospace",o.textAlign="center",o.textBaseline="middle",o.fillText("PAUSE!",l.width/2,l.height/2)))}}),I=requestAnimationFrame(U),document.addEventListener("keydown",function(e){if("Escape"===e.code){const t=document.createElement("a");t.href="main.html",t.click()}if("KeyR"===e.code){const n=document.createElement("a");n.href="tetris.html",n.click()}}),window.addEventListener("resize",()=>{n(),H(),k()})};